<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>親師溝通潤飾助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0fdf4; /* Light Green bg for calm */ }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #10b981; /* Emerald 500 */
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .markdown-body p { margin-bottom: 0.75em; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.75em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.75em; }
        .markdown-body strong { color: #065f46; font-weight: 700; }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-emerald-600 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fa-solid fa-comments text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-wide">親師溝通潤飾助手</h1>
                    <p class="text-xs text-emerald-100">讓溝通更有溫度，建立良好親師關係</p>
                </div>
            </div>
            <button onclick="toggleApiKeyModal()" class="text-sm bg-emerald-700 hover:bg-emerald-800 px-3 py-1.5 rounded-lg transition border border-emerald-500 flex items-center gap-2">
                <i class="fa-solid fa-key"></i>
                <span id="apiKeyStatus">設定 API Key</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-6 max-w-7xl mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Left Column: Input -->
        <div class="lg:col-span-5 space-y-4">
            <!-- Input Card -->
            <div class="glass-panel rounded-2xl p-5 h-full flex flex-col">
                <div class="flex justify-between items-center mb-3">
                    <label class="font-bold text-gray-700 flex items-center gap-2">
                        <i class="fa-solid fa-pen-to-square text-emerald-500"></i>
                        原始訊息/草稿
                    </label>
                    <span class="text-xs text-gray-400">請輸入您想傳達的重點</span>
                </div>
                
                <textarea id="rawInput" 
                    class="w-full flex-grow p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-400 focus:border-transparent outline-none resize-none bg-gray-50 text-base transition-all min-h-[250px]"
                    placeholder="例如：
小明最近作業常常沒交，上課也一直跟同學講話，希望能請家長在家多幫忙督促一下。

或是：
要通知下週五有戶外教學，記得帶水壺和便當，早上8點集合。"></textarea>

                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">溝通語氣</label>
                        <select id="toneSelect" class="w-full p-2.5 bg-white border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-400 outline-none">
                            <option value="warm">親切溫暖 (建立關係)</option>
                            <option value="tactful">專業委婉 (告知負面狀況)</option>
                            <option value="encouraging">正向鼓勵 (讚美與肯定)</option>
                            <option value="concise">簡潔明瞭 (行政通知)</option>
                            <option value="firm">堅定清晰 (強調規範)</option>
                        </select>
                    </div>
                    <div>
                         <label class="block text-sm font-medium text-gray-600 mb-1">額外需求 (選填)</label>
                         <input type="text" id="extraInstruction" placeholder="例：加上表情符號、要在聯絡簿手寫" class="w-full p-2.5 bg-white border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-400 outline-none">
                    </div>
                </div>

                <button onclick="generateRefinedText()" id="generateBtn" class="mt-4 w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-bold py-3 px-4 rounded-xl shadow-md transform transition hover:-translate-y-0.5 flex justify-center items-center gap-2">
                    <span id="btnText">AI 立即潤飾</span>
                    <div id="btnLoader" class="loader hidden"></div>
                </button>
            </div>
        </div>

        <!-- Right Column: Output & History -->
        <div class="lg:col-span-7 flex flex-col space-y-4 h-full">
            
            <!-- Output Card -->
            <div class="glass-panel rounded-2xl p-5 relative min-h-[300px]">
                <div class="flex justify-between items-center mb-3 border-b border-gray-100 pb-2">
                    <label class="font-bold text-gray-700 flex items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles text-emerald-500"></i>
                        潤飾結果
                    </label>
                    <div class="flex gap-2">
                        <button onclick="copyToClipboard()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded-lg transition flex items-center gap-1" title="複製內容">
                            <i class="fa-regular fa-copy"></i> 複製
                        </button>
                    </div>
                </div>
                
                <div id="outputArea" class="markdown-body text-gray-700 leading-relaxed text-base h-full overflow-y-auto max-h-[500px] p-2">
                    <div class="text-gray-400 text-center mt-10">
                        <i class="fa-solid fa-robot text-4xl mb-3 text-emerald-100"></i>
                        <p>準備好協助您的親師溝通。<br>請在左側輸入內容並點擊按鈕。</p>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div class="glass-panel rounded-2xl p-5 flex-grow overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-700 text-sm">
                        <i class="fa-solid fa-clock-rotate-left mr-2 text-emerald-500"></i>最近紀錄
                    </h3>
                    <div class="flex gap-2">
                         <button onclick="exportToCSV()" class="text-xs bg-emerald-50 hover:bg-emerald-100 text-emerald-600 px-3 py-1 rounded-lg transition">
                            <i class="fa-solid fa-file-csv mr-1"></i> 匯出 CSV
                        </button>
                        <button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-500 hover:bg-red-50 px-2 py-1 rounded transition">
                            清除
                        </button>
                    </div>
                </div>
                <div id="historyList" class="overflow-y-auto flex-grow space-y-3 pr-2" style="max-h: 300px;">
                    <!-- History items will be injected here -->
                    <p class="text-xs text-gray-400 text-center py-4">尚無紀錄</p>
                </div>
            </div>
        </div>
    </main>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl transform transition-all scale-100 mx-4">
            <h3 class="text-lg font-bold text-gray-800 mb-2">設定 Google Gemini API Key</h3>
            <p class="text-sm text-gray-500 mb-4">
                您的 API Key 僅會儲存在瀏覽器的 LocalStorage 中，不會上傳至任何其他伺服器。
                <br>沒有 Key 嗎？ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-emerald-500 underline">在此免費申請</a>
            </p>
            <input type="password" id="apiKeyInput" placeholder="貼上您的 API Key (AIza...)" 
                class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-emerald-500 outline-none">
            <div class="flex justify-end gap-3">
                <button onclick="toggleApiKeyModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition">取消</button>
                <button onclick="saveApiKey()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition font-medium">儲存</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 transform translate-y-20 opacity-0 transition-all duration-300 z-[70] flex items-center bg-white border-l-4 border-emerald-500 shadow-xl rounded-lg p-4 pr-8">
        <i id="toastIcon" class="fa-solid fa-circle-check text-emerald-500 text-xl mr-3"></i>
        <div>
            <h4 class="font-bold text-gray-800 text-sm">提示</h4>
            <p id="toastMsg" class="text-sm text-gray-600">操作成功</p>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';
        let historyData = JSON.parse(localStorage.getItem('comm_history') || '[]');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            updateApiKeyStatus();
            renderHistory();
        });

        // --- API Key Management ---
        function toggleApiKeyModal() {
            const modal = document.getElementById('apiKeyModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                document.getElementById('apiKeyInput').value = GEMINI_API_KEY;
            } else {
                modal.classList.add('hidden');
            }
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput').value.trim();
            if (input) {
                GEMINI_API_KEY = input;
                localStorage.setItem('gemini_api_key', GEMINI_API_KEY);
                updateApiKeyStatus();
                toggleApiKeyModal();
                showToast('API Key 已儲存');
            } else {
                showToast('請輸入有效的 API Key', 'error');
            }
        }

        function updateApiKeyStatus() {
            const statusText = document.getElementById('apiKeyStatus');
            if (GEMINI_API_KEY) {
                statusText.innerText = 'API Key 已設定';
                statusText.parentElement.classList.replace('bg-emerald-700', 'bg-emerald-800');
            } else {
                statusText.innerText = '設定 API Key';
            }
        }

        // --- Core Logic: Generate Content ---
        async function generateRefinedText() {
            if (!GEMINI_API_KEY) {
                toggleApiKeyModal();
                showToast('請先設定 API Key 才能使用', 'info');
                return;
            }

            const rawInput = document.getElementById('rawInput').value.trim();
            if (!rawInput) {
                showToast('請輸入訊息內容', 'error');
                return;
            }

            const toneMap = {
                'warm': '親切溫暖（強調關懷與連結，適合日常分享或建立關係）',
                'tactful': '專業委婉（三明治溝通法：肯定-建議-期許，適合告知負面行為或成績退步）',
                'encouraging': '正向鼓勵（放大優點，給予信心，適合讚美孩子）',
                'concise': '簡潔明瞭（重點條列，語氣客觀，適合行政通知或單純回報）',
                'firm': '堅定清晰（禮貌但有原則，適合重申班規或處理重複違規）'
            };

            const selectedToneKey = document.getElementById('toneSelect').value;
            const selectedTone = toneMap[selectedToneKey];
            const extraInstruction = document.getElementById('extraInstruction').value.trim();

            // UI Loading State
            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('btnLoader');
            
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            btnText.innerText = 'AI 思考中...';
            loader.classList.remove('hidden');

            try {
                // Construct Prompt
                const systemPrompt = `你是一位資深的教育工作者與公關溝通專家，非常擅長「親師溝通」。
你的任務是協助老師將原本較為口語、片段或可能帶有情緒的草稿文字，潤飾成適合傳送給家長（透過 Line、簡訊或聯絡簿）的專業訊息。

請嚴格遵循以下原則：
1. **語氣設定**：${selectedTone}。
2. **對象**：學生的家長。請使用適當的敬語（如「您」、「爸爸/媽媽好」），態度要尊重且專業。
3. **結構**：
   - 開頭：親切的問候。
   - 中段：清楚說明事項。若是負面事項，務必使用「三明治法」（先肯定孩子的一點優點，再溫和提出問題，最後提出親師合作的具體建議）。
   - 結尾：感謝家長的配合與支持。
4. **內容優化**：去除情緒化字眼，將責備轉化為「希望協助孩子進步」的建設性語言。
5. **易讀性**：適度分段，確保手機閱讀舒適。
6. **額外要求**：${extraInstruction ? extraInstruction : '無'}。

請直接輸出潤飾後的訊息內容，不需要解釋你的修改過程。`;

                const userPrompt = `原始內容：\n${rawInput}`;

                // Call Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: systemPrompt + "\n\n" + userPrompt }]
                        }]
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const generatedText = data.candidates[0].content.parts[0].text;
                
                // Display Result
                const outputArea = document.getElementById('outputArea');
                outputArea.innerHTML = marked.parse(generatedText);

                // Save to History
                addToHistory(rawInput, generatedText, selectedToneKey);
                
                showToast('潤飾完成！');

            } catch (error) {
                console.error(error);
                showToast('發生錯誤：' + error.message, 'error');
            } finally {
                // Reset UI
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                btnText.innerText = 'AI 立即潤飾';
                loader.classList.add('hidden');
            }
        }

        // --- History Management ---
        function addToHistory(original, refined, tone) {
            const newItem = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('zh-TW'),
                original: original,
                refined: refined,
                tone: tone
            };
            historyData.unshift(newItem); // Add to top
            if (historyData.length > 50) historyData.pop(); // Limit 50
            localStorage.setItem('comm_history', JSON.stringify(historyData));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';

            if (historyData.length === 0) {
                list.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">尚無紀錄</p>';
                return;
            }

            const toneLabels = {
                'warm': '親切溫暖', 'tactful': '專業委婉', 'encouraging': '正向鼓勵',
                'concise': '簡潔明瞭', 'firm': '堅定清晰'
            };

            historyData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-white p-3 rounded-xl border border-gray-100 hover:shadow-md transition cursor-pointer group';
                div.onclick = (e) => {
                    // Prevent triggering if clicking delete button
                    if(e.target.closest('.delete-btn')) return;
                    loadHistoryItem(item);
                };

                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] uppercase font-bold tracking-wider text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full">
                            ${toneLabels[item.tone] || item.tone}
                        </span>
                        <button class="delete-btn text-gray-300 hover:text-red-400 transition" onclick="deleteHistoryItem(${item.id})">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-800 line-clamp-2 font-medium mb-1">${escapeHtml(item.refined)}</p>
                    <p class="text-[10px] text-gray-400 text-right">${item.timestamp}</p>
                `;
                list.appendChild(div);
            });
        }

        function loadHistoryItem(item) {
            document.getElementById('rawInput').value = item.original;
            document.getElementById('toneSelect').value = item.tone;
            document.getElementById('outputArea').innerHTML = marked.parse(item.refined);
            // Scroll to top on mobile
            if(window.innerWidth < 1024) {
                 window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function deleteHistoryItem(id) {
            historyData = historyData.filter(item => item.id !== id);
            localStorage.setItem('comm_history', JSON.stringify(historyData));
            renderHistory();
            showToast('紀錄已刪除', 'info');
        }

        function clearHistory() {
            if(confirm('確定要清空所有紀錄嗎？')) {
                historyData = [];
                localStorage.removeItem('comm_history');
                renderHistory();
                showToast('紀錄已清空');
            }
        }

        // --- CSV Export ---
        function exportToCSV() {
            if (historyData.length === 0) {
                showToast('沒有紀錄可匯出', 'info');
                return;
            }

            // BOM for Excel Chinese characters
            let csvContent = "\uFEFF"; 
            csvContent += "時間,語氣,原始草稿,潤飾後訊息\n";

            historyData.forEach(item => {
                const toneMap = {
                    'warm': '親切溫暖', 'tactful': '專業委婉', 'encouraging': '正向鼓勵',
                    'concise': '簡潔明瞭', 'firm': '堅定清晰'
                };
                
                // Escape quotes for CSV
                const cleanOriginal = `"${(item.original || '').replace(/"/g, '""')}"`;
                const cleanRefined = `"${(item.refined || '').replace(/"/g, '""')}"`;
                const cleanTone = toneMap[item.tone] || item.tone;

                csvContent += `${item.timestamp},${cleanTone},${cleanOriginal},${cleanRefined}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `親師溝通紀錄_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Utilities ---
        function copyToClipboard() {
            const outputArea = document.getElementById('outputArea');
            if (!outputArea.innerText.trim()) return;

            navigator.clipboard.writeText(outputArea.innerText).then(() => {
                showToast('已複製到剪貼簿');
            }).catch(err => {
                showToast('複製失敗', 'error');
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toastMsg');
            const icon = document.getElementById('toastIcon');

            msg.innerText = message;
            
            if (type === 'error') {
                icon.className = 'fa-solid fa-circle-exclamation text-red-400 text-xl mr-3';
            } else if (type === 'info') {
                icon.className = 'fa-solid fa-circle-info text-blue-400 text-xl mr-3';
            } else {
                icon.className = 'fa-solid fa-circle-check text-emerald-500 text-xl mr-3';
            }

            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
