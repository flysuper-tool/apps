<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>輔導紀錄AI潤飾助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Fade in animation */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Recording Pulse Animation */
        .pulse-red {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse-red 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
        }
        @keyframes pulse-red {
            to {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-heart-pulse text-blue-600 text-xl"></i>
                <h1 class="font-bold text-lg text-slate-700">輔導紀錄AI潤飾助手</h1>
            </div>
            <button onclick="toggleSettings()" class="text-slate-500 hover:text-blue-600 transition px-3 py-1.5 rounded-md hover:bg-slate-100 flex items-center gap-2 text-sm font-medium border border-slate-200">
                <i class="fa-solid fa-key"></i>
                設定 API Key
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-5xl mx-auto px-4 py-6 w-full space-y-6">

        <!-- Data Persistence Warning -->
        <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded shadow-sm flex items-start gap-3">
            <i class="fa-solid fa-triangle-exclamation text-amber-500 mt-0.5"></i>
            <div class="text-sm text-amber-800">
                <p class="font-bold">資料保存警示：</p>
                <p>所有紀錄僅儲存在此瀏覽器的暫存空間 (IndexedDB)。若<span class="font-bold">清除瀏覽紀錄、更換手機或電腦</span>，資料將會遺失。請務必養成定期「匯出 CSV」備份的習慣。</p>
            </div>
        </div>

        <!-- API Key Settings Panel (Hidden by default unless no key) -->
        <div id="settingsPanel" class="hidden glass-panel rounded-xl shadow-lg p-6 mb-6 border-l-4 border-blue-500 fade-in">
            <h2 class="text-lg font-bold mb-3 flex items-center gap-2">
                <i class="fa-solid fa-key"></i> 設定 API Key
            </h2>
            
            <div class="text-sm text-slate-500 mb-4 leading-relaxed">
                <p class="mb-2">
                    請前往 <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline font-bold break-all">https://aistudio.google.com/app/apikey</a> 取得 API Key。
                    <button onclick="toggleTutorial()" class="inline-flex items-center gap-1 text-amber-600 hover:text-amber-700 underline font-medium ml-1">
                        <i class="fa-regular fa-image"></i> 步驟教學
                    </button>
                </p>
                <p>金鑰將僅儲存在您瀏覽器的 IndexedDB 中，不會上傳至任何第三方伺服器。</p>
            </div>

            <!-- Tutorial Image (Hidden by default) -->
            <div id="tutorialBox" class="hidden mb-4 overflow-hidden rounded-lg border border-slate-200 shadow-sm bg-slate-100 group relative">
                <img src="https://flysuper-tool.github.io/apps/Gemini_APIkey.png" alt="API Key 申請步驟教學" class="w-full h-auto cursor-zoom-in hover:opacity-95 transition" onclick="openImageModal(this.src)" title="點擊放大瀏覽">
                <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded pointer-events-none">點擊放大</div>
            </div>
            
            <!-- Modified Layout for Mobile: Stack vertically on small screens, row on larger -->
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="password" id="apiKeyInput" placeholder="貼上您的 API Key (AIzaSy...)" 
                    class="w-full sm:flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                
                <div class="flex gap-2 shrink-0">
                    <button onclick="saveApiKey()" class="flex-1 sm:flex-none bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-sm font-medium whitespace-nowrap">儲存</button>
                    <button onclick="clearApiKey()" class="flex-1 sm:flex-none bg-red-50 text-red-600 px-4 py-2 rounded-lg hover:bg-red-100 transition border border-red-200 whitespace-nowrap">刪除金鑰</button>
                </div>
            </div>
            <p id="keyStatus" class="mt-2 text-sm font-medium"></p>
        </div>

        <!-- Input Section -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
            <div class="flex justify-between items-center mb-2">
                <label class="block text-sm font-semibold text-slate-700">
                    原始口語/事件敘述 
                    <span class="text-xs font-normal text-slate-400 ml-2">(可多次編輯後重新潤飾)</span>
                </label>
                <span id="recordingStatus" class="text-xs font-medium text-red-500 hidden items-center gap-1 animate-pulse">
                    <i class="fa-solid fa-circle text-[8px]"></i> 正在聆聽...
                </span>
            </div>
            
            <div class="relative">
                <textarea id="rawInput" rows="5" placeholder="請在此輸入或點擊右下角麥克風按鈕開始說話..." 
                    class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 pr-12 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition resize-none"></textarea>
                
                <!-- Mic Button for Raw Input -->
                <button id="micBtn_rawInput" onclick="toggleRecording('rawInput')" class="absolute bottom-3 right-3 bg-white text-slate-500 p-2 rounded-full shadow-md border border-slate-200 hover:bg-slate-100 hover:text-blue-600 transition focus:outline-none z-10" title="語音輸入">
                    <i class="fa-solid fa-microphone"></i>
                </button>
            </div>
            
            <div class="mt-4 flex justify-end">
                <button id="processBtn" onclick="processWithAI()" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-2.5 rounded-lg hover:opacity-90 transition shadow-md flex items-center gap-2 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="btnIcon"><i class="fa-solid fa-wand-magic-sparkles"></i></span>
                    <span id="btnText">AI 潤飾紀錄</span>
                </button>
            </div>
        </div>

        <!-- Result Section (Generated by AI) -->
        <div id="resultSection" class="hidden bg-indigo-50 rounded-xl shadow-inner p-6 border border-indigo-100 fade-in">
            
            <!-- AI Question/Alert Box (Interactive) -->
            <div id="aiQuestionBox" class="hidden mb-4 bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r shadow-sm fade-in">
                <div class="flex flex-col gap-3">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i class="fa-solid fa-circle-question text-amber-400 mt-0.5"></i>
                        </div>
                        <div class="ml-3 w-full">
                            <h3 class="text-sm font-bold text-amber-800">AI 需要您補充以下資訊以完善紀錄：</h3>
                            <div class="mt-1 text-sm text-amber-800 leading-relaxed" id="aiQuestionText"></div>
                        </div>
                    </div>
                    
                    <!-- Answer Input Area -->
                    <div class="pl-8">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-amber-700/70">請輸入補充說明</span>
                            <span id="clarificationRecordingStatus" class="text-xs font-medium text-red-500 hidden items-center gap-1 animate-pulse">
                                <i class="fa-solid fa-circle text-[8px]"></i> 正在聆聽...
                            </span>
                        </div>
                        <div class="relative">
                            <textarea id="clarificationInput" rows="2" placeholder="請在此輸入或使用語音補充說明..." 
                                class="w-full bg-white border border-amber-200 rounded-lg px-3 py-2 pr-10 text-sm focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none transition placeholder-amber-300 text-slate-700 resize-none"></textarea>
                            
                            <!-- Mic Button for Clarification -->
                            <button id="micBtn_clarificationInput" onclick="toggleRecording('clarificationInput')" class="absolute bottom-2 right-2 bg-white text-slate-400 p-1.5 rounded-full shadow-sm border border-slate-200 hover:bg-slate-50 hover:text-blue-600 transition focus:outline-none z-10 text-xs" title="語音輸入">
                                <i class="fa-solid fa-microphone"></i>
                            </button>
                        </div>

                        <button id="clarifyBtn" onclick="submitClarification()" class="mt-2 bg-amber-500 text-white px-4 py-2 rounded-md hover:bg-amber-600 transition text-sm font-medium shadow-sm flex items-center gap-2">
                            <i class="fa-solid fa-reply"></i> 提交補充並重新潤飾
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center mb-2">
                <label class="block text-sm font-semibold text-indigo-800">AI 潤飾結果 (可編輯)</label>
                <span class="text-xs text-indigo-500 bg-white px-2 py-1 rounded-full border border-indigo-200">請確認事實無誤</span>
            </div>
            <textarea id="refinedOutput" rows="8" 
                class="w-full bg-white border border-indigo-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition"></textarea>
            
            <div class="mt-4 flex justify-end gap-3">
                <button onclick="cancelEdit()" class="px-4 py-2 text-slate-500 hover:text-slate-700 transition">取消 / 隱藏</button>
                <button onclick="saveRecord()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition shadow-sm font-medium flex items-center gap-2">
                    <i class="fa-solid fa-floppy-disk"></i> 寫入資料庫
                </button>
            </div>
        </div>

        <!-- History List -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-slate-50">
                <h3 class="font-bold text-slate-700 flex items-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left"></i> 紀錄列表
                </h3>
                <div class="flex flex-wrap gap-2">
                    <!-- Import CSV Button -->
                    <button onclick="document.getElementById('csvInput').click()" class="text-sm bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded hover:bg-slate-50 transition flex items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-file-import text-amber-600"></i> <span class="hidden sm:inline">匯入</span>
                    </button>
                    <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="importCSV(this)">

                    <!-- Share File Button -->
                    <button onclick="shareAllRecords()" class="text-sm bg-white border border-blue-200 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-50 transition flex items-center gap-2 shadow-sm" title="分享檔案到 LINE/雲端">
                        <i class="fa-solid fa-share-nodes"></i> <span class="hidden sm:inline">分享檔案</span>
                    </button>
                    <!-- Export CSV Button -->
                    <button onclick="exportToCSV()" class="text-sm bg-white border border-slate-300 text-slate-700 px-3 py-1.5 rounded hover:bg-slate-50 transition flex items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-file-csv text-green-600"></i> <span class="hidden sm:inline">匯出</span>
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 uppercase font-medium">
                        <tr>
                            <th class="px-6 py-3 w-24">日期</th>
                            <th class="px-6 py-3">原始口述</th>
                            <th class="px-6 py-3">潤飾後紀錄</th>
                            <th class="px-6 py-3 w-24 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="recordsList" class="divide-y divide-slate-100">
                        <!-- Records will be injected here -->
                        <tr>
                            <td colspan="4" class="px-6 py-8 text-center text-slate-400">目前尚無紀錄</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 transform translate-y-20 opacity-0 transition-all duration-300 z-[70] bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
        <i id="toastIcon" class="fa-solid fa-circle-check text-green-400"></i>
        <span id="toastMsg">操作成功</span>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 z-[60] bg-black bg-opacity-90 hidden flex justify-center items-center p-4 transition-opacity duration-300" onclick="closeImageModal()">
        <button class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 focus:outline-none z-[70]">&times;</button>
        <img id="modalImage" src="" alt="Enlarged Tutorial" class="max-w-full max-h-full rounded shadow-lg object-contain" onclick="event.stopPropagation()">
    </div>

    <script>
        // --- IndexedDB Configuration ---
        const DB_NAME = 'CounselingHelperDB';
        const DB_VERSION = 1;
        const STORE_SETTINGS = 'settings';
        const STORE_RECORDS = 'records';

        let db;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB();
            checkApiKey();
            loadRecords();
            initSpeechRecognition(); // Initialize Web Speech API
        });

        // --- Database Functions ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_SETTINGS)) {
                        db.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
                    }
                    if (!db.objectStoreNames.contains(STORE_RECORDS)) {
                        const recordStore = db.createObjectStore(STORE_RECORDS, { keyPath: 'id', autoIncrement: true });
                        recordStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error("IndexedDB Error:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function getSetting(key) {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_SETTINGS], 'readonly');
                const store = transaction.objectStore(STORE_SETTINGS);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result ? request.result.value : null);
                request.onerror = () => resolve(null);
            });
        }

        async function saveSetting(key, value) {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_SETTINGS], 'readwrite');
                const store = transaction.objectStore(STORE_SETTINGS);
                store.put({ key, value });
                transaction.oncomplete = () => resolve();
            });
        }

        async function deleteSetting(key) {
             return new Promise((resolve) => {
                const transaction = db.transaction([STORE_SETTINGS], 'readwrite');
                const store = transaction.objectStore(STORE_SETTINGS);
                store.delete(key);
                transaction.oncomplete = () => resolve();
            });
        }

        async function addRecord(data) {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_RECORDS], 'readwrite');
                const store = transaction.objectStore(STORE_RECORDS);
                store.add(data);
                transaction.oncomplete = () => resolve();
            });
        }

        async function getAllRecords() {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_RECORDS], 'readonly');
                const store = transaction.objectStore(STORE_RECORDS);
                const index = store.index('timestamp');
                const request = index.openCursor(null, 'prev'); // Newest first
                const results = [];
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        results.push(cursor.value);
                        cursor.continue();
                    } else {
                        resolve(results);
                    }
                };
            });
        }
        
        async function getRecordById(id) {
             return new Promise((resolve) => {
                const transaction = db.transaction([STORE_RECORDS], 'readonly');
                const store = transaction.objectStore(STORE_RECORDS);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
            });
        }

        async function deleteRecordById(id) {
             return new Promise((resolve) => {
                const transaction = db.transaction([STORE_RECORDS], 'readwrite');
                const store = transaction.objectStore(STORE_RECORDS);
                store.delete(id);
                transaction.oncomplete = () => resolve();
            });
        }

        // --- Web Speech API Logic ---
        let recognition;
        let isRecording = false;
        let recordingTargetId = null;

        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                const btns = document.querySelectorAll('[id^="micBtn_"]');
                btns.forEach(btn => btn.style.display = 'none');
                console.log("Speech recognition not supported");
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = () => {
                isRecording = true;
                updateMicUI(true);
            };

            recognition.onend = () => {
                isRecording = false;
                updateMicUI(false);
                recordingTargetId = null;
            };

            recognition.onerror = (event) => {
                console.error("Speech Recognition Error", event.error);
                isRecording = false;
                updateMicUI(false);
                recordingTargetId = null;
                if (event.error === 'not-allowed') {
                    showToast('請允許使用麥克風權限', 'error');
                } else if (event.error !== 'no-speech') {
                    showToast('語音辨識錯誤: ' + event.error, 'error');
                }
            };

            recognition.onresult = (event) => {
                if (!recordingTargetId) return;

                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }

                const targetInput = document.getElementById(recordingTargetId);
                if (targetInput && finalTranscript) {
                    targetInput.value += finalTranscript;
                }
            };
        }

        function toggleRecording(targetId) {
            if (!recognition) return;

            if (isRecording) {
                recognition.stop();
            } else {
                recordingTargetId = targetId;
                recognition.start();
            }
        }

        function updateMicUI(recording) {
            const resetUI = (targetId) => {
                const btn = document.getElementById(`micBtn_${targetId}`);
                const input = document.getElementById(targetId);
                let status;

                if (targetId === 'rawInput') {
                    status = document.getElementById('recordingStatus');
                    btn.className = "absolute bottom-3 right-3 bg-white text-slate-500 p-2 rounded-full shadow-md border border-slate-200 hover:bg-slate-100 hover:text-blue-600 transition focus:outline-none z-10";
                } else {
                    status = document.getElementById('clarificationRecordingStatus');
                    btn.className = "absolute bottom-2 right-2 bg-white text-slate-400 p-1.5 rounded-full shadow-sm border border-slate-200 hover:bg-slate-50 hover:text-blue-600 transition focus:outline-none z-10 text-xs";
                }

                btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
                status.classList.add('hidden');
                status.classList.remove('flex');
                input.classList.remove('ring-2', 'ring-red-100');
            };

            const activateUI = (targetId) => {
                 const btn = document.getElementById(`micBtn_${targetId}`);
                 const input = document.getElementById(targetId);
                 let status;

                 if (targetId === 'rawInput') {
                    status = document.getElementById('recordingStatus');
                    btn.className = "absolute bottom-3 right-3 bg-red-500 text-white p-2 rounded-full shadow-md border border-red-500 pulse-red transition focus:outline-none z-10";
                 } else {
                    status = document.getElementById('clarificationRecordingStatus');
                    btn.className = "absolute bottom-2 right-2 bg-red-500 text-white p-1.5 rounded-full shadow-sm border border-red-500 pulse-red transition focus:outline-none z-10 text-xs";
                 }
                 
                 btn.innerHTML = '<i class="fa-solid fa-microphone-lines"></i>';
                 status.classList.remove('hidden');
                 status.classList.add('flex');
                 input.classList.add('ring-2', 'ring-red-100');
            };

            resetUI('rawInput');
            resetUI('clarificationInput');

            if (recording && recordingTargetId) {
                activateUI(recordingTargetId);
            }
        }

        // --- Logic & UI Handlers ---

        async function checkApiKey() {
            const apiKey = await getSetting('gemini_api_key');
            const settingsPanel = document.getElementById('settingsPanel');
            const statusText = document.getElementById('keyStatus');
            const input = document.getElementById('apiKeyInput');

            if (apiKey) {
                statusText.innerHTML = '<span class="text-green-600"><i class="fa-solid fa-check-circle"></i> 已儲存 API Key</span>';
                input.value = '****************';
                input.disabled = true;
            } else {
                statusText.innerHTML = '<span class="text-amber-600"><i class="fa-solid fa-circle-exclamation"></i> 尚未設定 API Key</span>';
                settingsPanel.classList.remove('hidden');
                input.disabled = false;
            }
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        }

        function toggleTutorial() {
            const box = document.getElementById('tutorialBox');
            box.classList.toggle('hidden');
        }

        async function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            if (!key || key.startsWith('***')) return;

            await saveSetting('gemini_api_key', key);
            showToast('API Key 已儲存', 'success');
            checkApiKey();
            toggleSettings(); 
        }

        async function clearApiKey() {
            if(confirm('確定要從此瀏覽器刪除 API Key 嗎？之後需要重新輸入才能使用 AI 功能。')) {
                await deleteSetting('gemini_api_key');
                document.getElementById('apiKeyInput').value = '';
                document.getElementById('apiKeyInput').disabled = false;
                showToast('API Key 已移除', 'info');
                checkApiKey();
            }
        }

        async function processWithAI() {
            const rawText = document.getElementById('rawInput').value.trim();
            if (!rawText) {
                showToast('請先輸入內容', 'error');
                return;
            }

            const apiKey = await getSetting('gemini_api_key');
            if (!apiKey) {
                showToast('請先設定 Gemini API Key', 'error');
                toggleSettings();
                return;
            }

            // UI Loading State
            const btn = document.getElementById('processBtn');
            const icon = document.getElementById('btnIcon');
            const text = document.getElementById('btnText');
            
            btn.disabled = true;
            icon.innerHTML = '<div class="loader"></div>';
            text.innerText = 'AI 思考中...';
            
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('aiQuestionBox').classList.add('hidden');
            document.getElementById('clarificationInput').value = '';

            try {
                const result = await callGeminiAPI(apiKey, rawText);
                
                document.getElementById('refinedOutput').value = result.refined_text;
                document.getElementById('resultSection').classList.remove('hidden');

                if (result.needs_clarification && result.questions) {
                    const qBox = document.getElementById('aiQuestionBox');
                    const qText = document.getElementById('aiQuestionText');
                    qText.innerHTML = result.questions.replace(/\n/g, '<br>');
                    qBox.classList.remove('hidden');
                    showToast('AI 發現需要補充的資訊', 'info');
                    
                    setTimeout(() => {
                        document.getElementById('clarificationInput').focus();
                    }, 500);
                } else {
                    showToast('AI 潤飾完成', 'success');
                }
                
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error(error);
                showToast('AI 處理失敗: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                icon.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i>';
                text.innerText = 'AI 潤飾紀錄';
            }
        }

        async function submitClarification() {
            const rawText = document.getElementById('rawInput').value.trim();
            const clarification = document.getElementById('clarificationInput').value.trim();
            
            if (!clarification) {
                showToast('請輸入補充說明', 'error');
                return;
            }

            const apiKey = await getSetting('gemini_api_key');
            
            const btn = document.getElementById('clarifyBtn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="loader mr-2" style="border-top-color: white; border-left-color: white;"></div> 處理中...';

            const combinedText = `原始敘述：\n${rawText}\n\n補充說明(使用者針對疑問的回答)：\n${clarification}`;

            try {
                const result = await callGeminiAPI(apiKey, combinedText);
                
                document.getElementById('refinedOutput').value = result.refined_text;

                if (!result.needs_clarification) {
                    document.getElementById('aiQuestionBox').classList.add('hidden');
                    document.getElementById('clarificationInput').value = '';
                    showToast('已根據補充資訊完成潤飾', 'success');
                } else {
                    document.getElementById('aiQuestionText').innerHTML = result.questions.replace(/\n/g, '<br>');
                    document.getElementById('clarificationInput').value = '';
                    showToast('AI 仍有疑問，請繼續補充', 'info');
                }
            } catch (error) {
                console.error(error);
                showToast('處理失敗: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        async function callGeminiAPI(key, text) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            
            const prompt = `
                角色：你是一位資深的輔導諮商督導。
                任務：將以下的使用者口語敘述改寫為一份專業的「輔導/事件紀錄」。

                規則：
                1. 保持客觀：不要添加不存在的事實。
                2. 圓融潤飾：將情緒化字眼轉化為中性、專業用語。
                3. 邏輯檢查：如果原始敘述嚴重缺乏關鍵資訊(如：主詞不明、時間錯亂、事件因果完全斷裂)，請在回傳的JSON中標註需要補充。
                4. 語言：繁體中文（台灣）。
                
                輸出格式：請務必輸出標準的 JSON 格式，不要包含 markdown 標籤（如 \`\`\`json）。JSON 結構如下：
                {
                    "needs_clarification": boolean,  // 如果資訊嚴重不足回傳 true，否則 false
                    "questions": "string",           // 如果上一項為 true，列出具體的提問或建議補充點；否則留空
                    "refined_text": "string"         // 這是你的潤飾結果。即使資訊不足，也請盡力根據現有資訊提供一個草稿(並融入使用者的補充說明)
                }

                原始敘述(可能包含後續補充)：
                "${text}"
            `;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error?.message || 'API 請求失敗');
            }

            const data = await response.json();
            const responseText = data.candidates[0].content.parts[0].text.trim();
            
            try {
                const cleanJson = responseText.replace(/```json/g, '').replace(/```/g, '');
                return JSON.parse(cleanJson);
            } catch (e) {
                console.warn("JSON Parse failed, falling back to text", e);
                return {
                    needs_clarification: false,
                    questions: "",
                    refined_text: responseText
                };
            }
        }

        function cancelEdit() {
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('refinedOutput').value = '';
            document.getElementById('aiQuestionBox').classList.add('hidden');
        }

        async function saveRecord() {
            const rawText = document.getElementById('rawInput').value.trim();
            const refinedText = document.getElementById('refinedOutput').value.trim();

            if (!refinedText) return;

            const record = {
                timestamp: new Date().toISOString(),
                raw: rawText,
                refined: refinedText
            };

            await addRecord(record);
            showToast('紀錄已寫入資料庫', 'success');
            
            document.getElementById('rawInput').value = '';
            cancelEdit();
            loadRecords();
        }

        async function loadRecords() {
            const list = document.getElementById('recordsList');
            const records = await getAllRecords();

            if (records.length === 0) {
                list.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">目前尚無紀錄</td></tr>`;
                return;
            }

            list.innerHTML = records.map(r => {
                const date = new Date(r.timestamp).toLocaleString('zh-TW', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit' 
                });
                return `
                    <tr class="hover:bg-slate-50 transition group">
                        <td class="px-6 py-4 whitespace-nowrap text-slate-500 font-mono text-xs">${date}</td>
                        <td class="px-6 py-4">
                            <div class="max-w-xs truncate text-slate-400 text-sm" title="${escapeHtml(r.raw)}">${escapeHtml(r.raw)}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-slate-700 text-sm line-clamp-3">${escapeHtml(r.refined)}</div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex justify-center items-center gap-2">
                                <button onclick="shareRecord(${r.id})" class="text-blue-400 hover:text-blue-600 transition p-2 rounded hover:bg-blue-50" title="分享單筆紀錄">
                                    <i class="fa-solid fa-share-from-square"></i>
                                </button>
                                <button onclick="deleteRecord(${r.id})" class="text-red-400 hover:text-red-600 transition p-2 rounded hover:bg-red-50" title="刪除">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        async function deleteRecord(id) {
            if(confirm("確定要刪除這條紀錄嗎？此動作無法復原。")) {
                await deleteRecordById(id);
                loadRecords();
                showToast('紀錄已刪除', 'info');
            }
        }

        function generateCSVContent(records) {
            let csvContent = "\uFEFF";
            csvContent += "時間,原始敘述,潤飾後紀錄\n";
            records.forEach(r => {
                const date = new Date(r.timestamp).toLocaleString('zh-TW');
                const raw = `"${r.raw.replace(/"/g, '""')}"`;
                const refined = `"${r.refined.replace(/"/g, '""')}"`;
                csvContent += `${date},${raw},${refined}\n`;
            });
            return csvContent;
        }

        async function exportToCSV() {
            const records = await getAllRecords();
            if (records.length === 0) {
                showToast('沒有資料可匯出', 'error');
                return;
            }
            const csvContent = generateCSVContent(records);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `輔導紀錄匯出_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('CSV 下載已開始', 'success');
        }

        async function shareAllRecords() {
            const records = await getAllRecords();
            if (records.length === 0) {
                showToast('沒有資料可分享', 'error');
                return;
            }
            
            const csvContent = generateCSVContent(records);
            const fileName = `輔導紀錄_${new Date().toISOString().slice(0,10)}.csv`;
            const file = new File([csvContent], fileName, { type: 'text/csv' });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: '輔導紀錄備份',
                        text: '這是匯出的輔導紀錄 CSV 檔案。'
                    });
                    showToast('分享成功', 'success');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Sharing failed', err);
                        showToast('分享失敗，請改用匯出功能', 'error');
                        exportToCSV(); // Fallback
                    }
                }
            } else {
                showToast('您的瀏覽器不支援檔案分享，將進行下載', 'info');
                exportToCSV();
            }
        }

        async function shareRecord(id) {
            const record = await getRecordById(id);
            if (!record) return;

            const date = new Date(record.timestamp).toLocaleString('zh-TW');
            const shareText = `【輔導/事件紀錄】\n時間：${date}\n\n原始敘述：\n${record.raw}\n\n潤飾後內容：\n${record.refined}`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: '單筆輔導紀錄',
                        text: shareText
                    });
                } catch (err) {
                    if (err.name !== 'AbortError') {
                         // Fallback to clipboard
                         navigator.clipboard.writeText(shareText);
                         showToast('分享失敗，已複製文字到剪貼簿', 'info');
                    }
                }
            } else {
                // Fallback to clipboard
                navigator.clipboard.writeText(shareText);
                showToast('已複製文字到剪貼簿', 'success');
            }
        }
        
        // --- CSV Import Function ---
        function importCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const rows = parseCSV(text);
                
                if (rows.length === 0) {
                    showToast('CSV 格式錯誤或無資料', 'error');
                    return;
                }

                let addedCount = 0;
                // Start from 1 to skip header (assuming header exists)
                // If the first row looks like data, we might need better detection, 
                // but standard export has "時間,原始敘述,潤飾後紀錄"
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length < 3) continue; // Skip empty or malformed rows

                    // row[0] is time string, row[1] is raw, row[2] is refined
                    // We generate a new timestamp to ensure it's valid ISO, or try to parse
                    // But to keep sort order, we should probably try to respect the original time or just use current time?
                    // The exported format is locale string, which is hard to parse back exactly to ISO.
                    // Strategy: Use current time for import to bring them to "top", OR try to parse.
                    // Let's use current time for simplicity and to indicate "imported just now".
                    // OR: To act as a backup restore, we might want original dates.
                    // Since locale string varies by browser, parsing is risky. 
                    // Let's stick to generating a new ISO string to guarantee valid data structure.
                    
                    // Actually, if it's a backup, preserving dates is better. 
                    // Let's try to parse, fallback to now.
                    let timestamp = new Date().toISOString();
                    const parsedDate = new Date(row[0]);
                    if (!isNaN(parsedDate.getTime())) {
                        timestamp = parsedDate.toISOString();
                    }

                    const record = {
                        timestamp: timestamp,
                        raw: row[1] || "",
                        refined: row[2] || ""
                    };
                    
                    if(record.raw || record.refined) {
                        await addRecord(record);
                        addedCount++;
                    }
                }

                showToast(`成功匯入 ${addedCount} 筆資料`, 'success');
                loadRecords();
                input.value = ''; // Reset input
            };
            reader.readAsText(file);
        }

        // Simple CSV Parser handling quotes
        function parseCSV(text) {
            // Remove BOM if present
            if (text.charCodeAt(0) === 0xFEFF) {
                text = text.slice(1);
            }
            
            const rows = [];
            let currentRow = [];
            let currentVal = '';
            let insideQuote = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i+1];

                if (insideQuote) {
                    if (char === '"' && nextChar === '"') {
                        currentVal += '"';
                        i++; // Skip next quote
                    } else if (char === '"') {
                        insideQuote = false;
                    } else {
                        currentVal += char;
                    }
                } else {
                    if (char === '"') {
                        insideQuote = true;
                    } else if (char === ',') {
                        currentRow.push(currentVal);
                        currentVal = '';
                    } else if (char === '\n' || char === '\r') {
                        if (char === '\r' && nextChar === '\n') i++; // Handle CRLF
                        currentRow.push(currentVal);
                        rows.push(currentRow);
                        currentRow = [];
                        currentVal = '';
                    } else {
                        currentVal += char;
                    }
                }
            }
            if (currentVal || currentRow.length > 0) {
                currentRow.push(currentVal);
                rows.push(currentRow);
            }
            return rows;
        }

        // --- Image Modal Functions ---
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = src;
            modal.classList.remove('hidden');
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
        }

        // --- Utilities ---
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toastMsg');
            const icon = document.getElementById('toastIcon');

            msg.innerText = message;
            
            if (type === 'error') {
                icon.className = 'fa-solid fa-circle-exclamation text-red-400';
            } else if (type === 'info') {
                icon.className = 'fa-solid fa-circle-info text-blue-400';
            } else {
                icon.className = 'fa-solid fa-circle-check text-green-400';
            }

            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
